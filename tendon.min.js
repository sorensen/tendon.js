(function(){"use strict";function t(s,r,o){this.log("[Tendon.init]");var a=this;i.extend(this,e.Events),this.$main="string"==typeof s?n(s):s,this.context=r||{},this.options=i.extend({},t.defaults,o||{});var u=this.options.prefix,p=s.find(["template","set-value","set-attribute","listen-to","auto-render","publish","subscribe"].map(function(t){return u+t}).join(","));p.each(function(t,e){a.setup(e)})}var e=this.Backbone,i=this._,n=this.$;t.defaults=Object.freeze({prefix:"tendon-",templateSettings:{variable:"__",evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g}}),t.prototype.log=function(){return this.options.debug?(console.log.apply(console,arguments),this):this},t.prototype.getTemplate=function(t){this.log("[Tendon.getTemplate] selector=`%s`",t);var e=this.$main.find(t),n=e.html();if(!n)throw new Error("Invalid template: "+t);return i.template(n,this.options.templateSettings)},t.prototype.getValue=function(t){var e=t.attr(this.prefix+"set-value"),n=e.split(":"),s=this.context[n[0]],r=n[1];return i.isFunction(s[r])?s[r]():s.get(r)},t.prototype.updateElement=function(t){var e=this.prefix,i=t.attr(e+"template"),n=t.attr(e+"set-value"),s=t.attr(e+"set-attribute"),r=t.attr("id");this.log("[Tendon.updateElement] id=`%s`",r),i&&(i=this.getTemplate(i));var o;return i?o=i(this.context):n&&(o=this.getValue(t)),s?t.attr(s,o||""):i?t.html(o):t.is("input, select, textarea")?t.val(o):t.html(o),r&&(this.log("[Tendon.updateElement] id="+r,t),this.trigger("updateElement:"+r,t)),this},t.prototype.setupPublish=function(t){var e=this,i=this.prefix,s=t.attr(i+"publish"),r=t.attr(i+"listen-to");return s?(t.is("input, select, textarea")?t.on("change",function(){e.onHTMLChange(t)}):r?t.on("click",r,function(i){var s=n(i.target).closest(r);e.onHTMLChange(t,s)}):t.on("click",function(){e.onHTMLChange(t)}),this):this},t.prototype.onHTMLChange=function(t,e){var i,n=this,s=this.prefix,r=e||t,o=t.attr(s+"publish")||"",a=t.attr(s+"listen-to"),u=this.id(t);return i=r.is("input, select, textarea")?r.val():a?r.data():r.html(),this.log("[Tendon.onHTMLChange] value=`%s` publish=`%s` $el=`%s`",i,o,t),o.split(",").forEach(function(t){var e=t.split(":"),s=n.context[e[0]],r=e[1];s.set(r,i,{source:u})}),this},t.prototype.setupSubscribe=function(t){var e=this,i=t.attr(this.prefix+"subscribe")||"";return i.split(",").forEach(function(i){var n=i.split("."),s=n[0],r=n[1],o=e.context[s];if(!o)throw new Error("Invalid subject: "+i);e.log("[Tendon.setupSubscribe] obj=`%s` event=`%s` id=`%s`",s,r,t.attr("id")),o.on(r,function(i,n,s){e.onJSChange(t,i,n,s)})}),this},t.prototype.onJSChange=function(t,e,i,n){var s=this.id(t);return n&&n.source===s?this:this.updateElement(t)},t.prototype.setup=function(t){var e=n(t),i=this.prefix,s=e.attr("id"),r=e.attr(i+"subscribe"),o=e.attr(i+"publish"),a=e.attr(i+"auto-render");return this.log("[Tendon.setup] id=`%s` subs=`%s` pubs=`%s` auto=`%s`",s,r,o,a),a&&this.updateElement(e),r&&this.setupSubscribe(e),o&&this.setupPublish(e),this},t.prototype.id=function(t){var e=this.prefix+"uuid",n=t.attr(e);return n||(n=i.uniqueId(this.prefix),t.attr(e,n)),n},"undefined"!=typeof exports?module.exports=t:this.Tendon=t}).call(this);