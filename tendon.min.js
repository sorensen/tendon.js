(function(){"use strict";function t(s,o,u){var c=this;n.extend(this,e.Events),this.$selector="string"==typeof s?i(s):s,this.context=o||{};var l=this.options=n.extend({},t.defaults,u||{});this.prefix=l.prefix,r("[Tendon.init]",s,o,l),this.adapters=n.extend({},a,l.adapters||{}),this.setup(),setTimeout(function(){c.trigger("init:before")},0),setTimeout(function(){c.trigger("init")},0),setTimeout(function(){c.trigger("init:after")},0)}var e,n,i,r,s=Array.prototype.slice;"undefined"!=typeof require?(e=require("backbone"),n=require("underscore"),i=require("jquery"),r=require("debug")("tendon"),r=function(){}):(e=this.Backbone,n=this._,i=this.$,r=function(){console.log.apply(null,arguments)}),t.defaults={prefix:"tendon-",debug:!0,templateSettings:{variable:"data",evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g}},t.prototype.setup=function(){var t=this,e=this.prefix,a=Object.keys(this.adapters),o=a.map(function(t){return"["+e+t+"]"}).join(",");return this.$selector.find(o).each(function(o,u){var c=i(u),l={};s.call(u.attributes).forEach(function(t){l[t.name]=t.value}),c._tendon={},c._events={},a.filter(function(e){var i=t.adapters[e].autoload;return n.isFunction(i)?i.apply(t,[c,l]):i}).forEach(function(t){l[e+t]||(l[e+t]=null)}),Object.keys(l).filter(function(t){return 0===t.indexOf(e)}).map(function(t){return t.replace(e,"")}).filter(function(e){return t.adapters.hasOwnProperty(e)}).forEach(function(i){var s=t.adapters[i],a=l[e+i],o=s.event||"init",u=n.isFunction(s)?s:s.method;r("[Tendon.enable] adapter=`%s` event=`%s` el=`%s`",i,o,l.id),c._tendon[i]=s,c._events[o]||(c._events[o]=[]),c._events[o].push(u),t.on(o,function(){console.log("[trigger] adapter=`%s` event=`%s` el=`%s`",i,o,l.id,arguments),0===o.indexOf("init")?u.apply(t,[c,a,i]):u.apply(t,arguments)})})}),console.log("[Tendon.enable] setup complete"),this},t.prototype.ctx=function(t,e){if(!t)return null;var i=t.split("."),r=i.pop(),a=(r||"").split(":"),o=a[0],u=a.slice(1).join(":"),c=u.split(","),l=s.call(arguments,1),h=this.context;if(!i.length&&!h.hasOwnProperty(r))return t;for(var p=0;p<i.length;p++){var f=i[p];if(!h.hasOwnProperty(f))return console.error("[Adapters.set] Invalid context: `%s`",i.join(".")),null;h=h[f]}if(c=c.map(function(t){return t.trim()}),n.isFunction(h[o])){var d=c.concat(l);return console.log("[ctx]: ",h,o,d),h[o].apply(h,d)}return e?h[o]=e:h[o]};var a={};a.get={event:"init:before",autoload:!0,method:function(t,e){var r=t.attr(this.prefix+"listen"),s=(e||"").split(":"),a=s.pop(),o=s[0],u=o?t.find(o):t;return t.tendonGet=function(s){if(e&&u.hasOwnProperty(a))return n.isFunction(u[a])?u[a]():u[a];if(t.is("input, select, textarea"))return t.val();if(s&&r){u=i(s.target).closest(r);var o=u.data();if(!n.isEmpty(o))return o}return u.html()},this}},a.template={event:"change:js",method:function(t,e,i,r){var s,a=this,o=t.attr(this.prefix+"template"),u=t.attr("id"),c=this.ctx(o);if(!c)return this;console.log("[Adapters.template] running: selector=`%s`",c,arguments),this._cache||(this._cache={});var s=this._cache[c];if(!s){var l=this.$selector.find(c).html(),h=n.template(l,this.options.templateSettings);s=this._cache[c]=h}if(!s)throw new Error("Invalid template: "+c);var p=s(this.context);return t.is("input, textarea")?t.val(p):t.html(p||""),setTimeout(function(){u&&a.trigger("render:html:"+u,t,p,e,i,r),a.trigger("render:html",t,p,e,i,r)},0),this}},a.set={event:"change:js",children:["set-attribute"],method:function(t,e,n,i){var r=this,s=this.prefix,a=t.attr("id"),o=t.attr(s+"set")||"",u=t.attr(s+"set-attribute"),c=this.ctx(o);return u?t.attr(u,c||""):t.is("input, textarea")?t.val(c):t.html(c),setTimeout(function(){a&&r.trigger("render:html:"+a,t,c,e,n,i),r.trigger("render:html",t,c,e,n,i)},0),this}},a["auto-render"]={event:"init:after",method:function(t){var e=this;return["set","template"].forEach(function(n){e.adapters[n]&&e.adapters[n].method.apply(e,[t])}),this}},a.uuid={event:"init",autoload:!0,method:function(t,e){var i=this.prefix,r=i+"uuid";return e||t.attr(r,n.uniqueId(i)),this}},a.publish={event:"change:html",method:function(t,e,n){var i=this,r=this.prefix,s=t.attr(r+"publish"),a=t.attr(r+"uuid");return s.split("/").forEach(function(t){i.ctx(t,e,{source:a})}),this}},a.listen={event:"init",autoload:function(t,e){var n=this.prefix;return e.hasOwnProperty(n+"publish")},method:function(t,e){function n(e){var n=t.tendonGet(e);r("[Adapters.listen] triggering `change:html` event id=`%s` el=",s,t);var a=t._events["change:html"]||[];return a.forEach(function(r){r.apply(i,[t,n,e])}),this}var i=this,s=t.attr("id");return"false"===e?this:(t.is("input, select, textarea")?t.on("change",n):e?t.on("click",e,n):t.on("click",n),this)}},a.subscribe={event:"init",method:function(t,e){var n=this,i=this.prefix;return e.split("/").forEach(function(e){n.ctx(e,function(r,s,a){var o=t.attr(i+"uuid");if(!a||a.source!==o){console.log("\n\ntriggering `change:js` for: ",e,s,t.attr("id"));var u=t._events["change:js"]||[];console.log("methods: ",u),u.forEach(function(e){e.apply(n,[t,r,s,a])})}})}),this}},"undefined"!=typeof exports?module.exports=t:this.Tendon=t}).call(this);